<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Phantoms007">



<meta name="description" content="MySQL性能优化之骨灰级高阶神技前言大量信息的存储和查询都会用到 MySQL，因此它的优化就对系统性能提升就尤为重要了。由于 MySQL 的优化范围较广，从软件到硬件，从配置到应用，无法一一道来。今天就从开发者的角度介绍一下 MySQL 应用优化。包括数据类型，数据表查询/修改，索引和查询等几个方面。">
<meta name="keywords" content="MySql,索引,优化,数据库设计">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL性能优化之骨灰级高阶神技">
<meta property="og:url" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/index.html">
<meta property="og:site_name" content="随笔小记">
<meta property="og:description" content="MySQL性能优化之骨灰级高阶神技前言大量信息的存储和查询都会用到 MySQL，因此它的优化就对系统性能提升就尤为重要了。由于 MySQL 的优化范围较广，从软件到硬件，从配置到应用，无法一一道来。今天就从开发者的角度介绍一下 MySQL 应用优化。包括数据类型，数据表查询/修改，索引和查询等几个方面。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/回表示意图.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/查询流程图.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/查看慢查询日志是否开启.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/开启慢查询日志.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/设置慢查询日志的时间.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/查看sql语句.jpg">
<meta property="og:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/Explain.jpg">
<meta property="og:updated_time" content="2020-04-29T08:44:19.622Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL性能优化之骨灰级高阶神技">
<meta name="twitter:description" content="MySQL性能优化之骨灰级高阶神技前言大量信息的存储和查询都会用到 MySQL，因此它的优化就对系统性能提升就尤为重要了。由于 MySQL 的优化范围较广，从软件到硬件，从配置到应用，无法一一道来。今天就从开发者的角度介绍一下 MySQL 应用优化。包括数据类型，数据表查询/修改，索引和查询等几个方面。">
<meta name="twitter:image" content="https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/回表示意图.jpg">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="随笔小记" type="application/atom+xml">



    <link rel="shortcut icon" href="/img/AcFun.png">



    <link href="/js/animate.min.css" rel="stylesheet">



    <link href="/js/jquery.fancybox.min.css" rel="stylesheet">



    <script src="/js/pace.min.js"></script>
   

    <link href="/js/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">



<link href="/js/font-awesome.min.css" rel="stylesheet">


<title>MySQL性能优化之骨灰级高阶神技 | 随笔小记</title>

<script src="/js/jquery-2.2.4.min.js"></script>
<script src="/js/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "/js/jquery.fancybox.min.js",
        scrollreveal: "/js/scrollreveal.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "/js/jquery-ui.min.js", "/js/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    


</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/AcFun.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Phantoms007</a></h1>
        </hgroup>

        
        <p class="header-subtitle">时间是生命的度量衡，人类文明的意义是知识的学习与传承</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false">
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class="no-result">No results found <i class="fa fa-spinner fa-pulse"></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/203406918@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa 知乎" href="/zhihu" title="知乎"></a>
                            
                                <a class="fa 豆瓣" href="/douban" title="豆瓣"></a>
                            
                                <a class="fa 简书" href="/jianshu" title="简书"></a>
                            
                                <a class="fa CSDN" href="/" title="CSDN"></a>
                            
                                <a class="fa QQ" href="#" title="QQ"></a>
                            
                                <a class="fa 微信" href="/Wechat" title="微信"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ABA/">ABA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAS/">CAS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Get/">Get</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySql/">MySql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PDF/">PDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Post/">Post</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sphinx/">Sphinx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/innodb/">innodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前后交互/">前后交互</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/扣款/">扣款</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库设计/">数据库设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/秒杀/">秒杀</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/索引/">索引</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/请求方式/">请求方式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/锁/">锁</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">时间是生命的度量衡，人类文明的意义是知识的学习与传承</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Phantoms007</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/AcFun.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Phantoms007</a></h1>
            </hgroup>
            
            <p class="header-subtitle">时间是生命的度量衡，人类文明的意义是知识的学习与传承</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/203406918@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa 知乎" target="_blank" href="/zhihu" title="知乎"></a>
                            
                                <a class="fa 豆瓣" target="_blank" href="/douban" title="豆瓣"></a>
                            
                                <a class="fa 简书" target="_blank" href="/jianshu" title="简书"></a>
                            
                                <a class="fa CSDN" target="_blank" href="/" title="CSDN"></a>
                            
                                <a class="fa QQ" target="_blank" href="#" title="QQ"></a>
                            
                                <a class="fa 微信" target="_blank" href="/Wechat" title="微信"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap"><article id="post-MySQL性能优化之骨灰级高阶神技" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/28/MySQL性能优化之骨灰级高阶神技/" class="article-date">
      <time datetime="2020-04-28T10:00:00.000Z" itemprop="datePublished">2020-04-28</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      MySQL性能优化之骨灰级高阶神技
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySql/">MySql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/优化/">优化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库设计/">数据库设计</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/索引/">索引</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <excerpt in index | 首页摘要>




<h2 id="MySQL性能优化之骨灰级高阶神技"><a href="#MySQL性能优化之骨灰级高阶神技" class="headerlink" title="MySQL性能优化之骨灰级高阶神技"></a>MySQL性能优化之骨灰级高阶神技</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>大量信息的存储和查询都会用到 MySQL，因此它的优化就对系统性能提升就尤为重要了。由于 MySQL 的优化范围较广，从软件到硬件，从配置到应用，无法一一道来。今天就从开发者的角度介绍一下 MySQL 应用优化。包括数据类型，数据表查询/修改，索引和查询等几个方面。</p>
<a id="more"></a>
<the rest of contents | 余下全文>



<h2 id="数据类型优化"><a href="#数据类型优化" class="headerlink" title="数据类型优化"></a>数据类型优化</h2><p>字段是用来存放数据的单元，设计好字段是设计数据库的第一步，同样会影响到系统的性能。设计字段有一个基本的原则，保小不保大，也就是能够用字节少的字段就不用字节数大的字段，目的是为了节省空间，提高查询效率。更小的字段，占用更小的磁盘空间，内存空间，更小的 IO 消耗。下面针对使用场景，说一些字段类型选取的经验，供大家参考。</p>
<h3 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h3><ul>
<li>手机号：通常我们在存储手机号的时候，喜欢用 Varchar 类型。如果是 11 位的手机号，假设我们用 utf8 的编码，每位字节就需要 3 个字节，那么就需要 11*33=33 个字节来存放;如果我们使用 bigint，只需要 8 个字节就可以存放。</li>
<li>IP 地址：同上，IP 地址也可以通过 int(4 字节)在存放，可以通过 INET_ATON() 函数把 IP 地址转成数字。这里需要注意溢出的问题，需要用无符号的 int。</li>
<li>年龄、枚举类型：可以用 tinyint 来存放，它只占用 1 个字节，无符号的 tinyint 可以表示 0-255 的范围，基本够用了。</li>
</ul>
<h3 id="字符类型"><a href="#字符类型" class="headerlink" title="字符类型"></a>字符类型</h3><p>Char 和 Varchar 是我们常用的字符类型。</p>
<ul>
<li>char(N) 用来记录固定长度的字符，如果长度不足 N 的，用空格补齐。</li>
<li>varchar(N) 用来保存可变长度的字符，它会额外增加 1-2 字节来保存字符串的长度。</li>
<li>Char 和 Varchar 占用的字节数，根据数据库的编码格式不同而不同。Latin1 占用 1 个字节，gbk 占用 2 个字节，utf8 占用 3 个字节。</li>
</ul>
<p>用法方面</p>
<ul>
<li>如果存储的内容是可变长度的，例如：家庭住址，用户描述就可以用 Varchar。</li>
<li>如果内容是固定长度的，例如：UUID(36 位)，或者是 MD5 加密串(32 位)，就可以使用 Char 存放。</li>
</ul>
<h3 id="时间类型"><a href="#时间类型" class="headerlink" title="时间类型"></a>时间类型</h3><p>Datetime 和 Timestamp 都是可以精确到秒的时间类型，但是 Datetime 占用 8 个字节，而 Timestamp 占用 4 个字节。<br>所以在日常建表的时候可以有限选择 Timestamp。不过他们有下面几个小区别，需要注意的。</p>
<h4 id="区别一：存储数据方式不一样。"><a href="#区别一：存储数据方式不一样。" class="headerlink" title="区别一：存储数据方式不一样。"></a>区别一：存储数据方式不一样。</h4><p>Timestamp 是转化成 utc 时间进行存储，查询时，转化为客户端时间返回的。</p>
<h4 id="区别二：两者存储时间的范围不一样。"><a href="#区别二：两者存储时间的范围不一样。" class="headerlink" title="区别二：两者存储时间的范围不一样。"></a>区别二：两者存储时间的范围不一样。</h4><p>Timestamp    为’1970-01-01 00:00:01.000000’ 到’2038-01-19 03:14:07.999999’。<br>Datetime    为’1000-01-01 00:00:00.000000’ 到’9999-12-31 23:59:59.999999’。</p>
<h2 id="数据表查询-修改优化"><a href="#数据表查询-修改优化" class="headerlink" title="数据表查询/修改优化"></a>数据表查询/修改优化</h2><p>说了如何高效地选择存储数据的类型以后，再来看看如何高效地读取数据。</p>
<p>MySQL 作为关系型数据库，在处理复杂业务的时候多会选择表与表之间的关联。这会导致我们在查询数据的时候，会关联其他的表，特别是一些多维度数据查询的时候，这种关联就尤为突出。<br>此时，为了提高查询的效率，我们会对某些字段做冗余处理，让这些字段同时存在于多张表中。</p>
<p>但是，这又会带来其他的问题，例如：如果针对冗余字段进行修改的时候，就需要对多张表进行修改，并且需要让这个修改保持在一个事物中。如果处理不当，会导致数据的不一致性。这里需要根据具体情况采取查询策略，例如：需要跨多张表查询公司销售额信息。由于，销售信息需要连接多张表，并且对销售量和金额做求和操作，直接查询显然是不妥当的。可以生成后台服务，定时从相关表中取出信息，计算出结果放入一张汇总表中。将汇总表中需要查询的条件字段加上索引信息，提高查询的效率。这种做法，限于查询数据实时性不强的情况。</p>
<p>在高速迭代开发过程中，业务变化快，数据库会根据业务的变化进行迭代。所以，在开发新产品初期，表结构会面临频繁地修改。MySQL 的 ALTERTABLE 操作性能对大表来说是个问题。MySQL执行修改表结构操作的方法是，用新的结构创建一个空表，从旧表中查出所有数据插入新表，然后删除旧表。这一操作需要花费大量时间，如果内存不足而表数据很大，并且索引较多的情况，会造成长时间的锁表。有极端的情况，有些 ALTERTABLE 操作需要花费数个小时甚至数天才能完成。</p>
<h3 id="两种小技巧"><a href="#两种小技巧" class="headerlink" title="两种小技巧"></a>两种小技巧</h3><ul>
<li>先把数据库拷贝到一台非生产服务器上，在上面做修改表操作，此时的修改不会影响生产库。修改完毕以后在做数据库的切换，把非生产数据库切换成生产库。不过需要注意的时候，在做表结构修改的时候，生产库会生成一些数据。这里需要通过脚本根据时间区间导入这部分数据。</li>
<li>“影子拷贝”，即生成一张表结构相同的不同名新数据表(更改数据结构以后的表)。然后导入原表的数据到新表，导入成功以后停止数据库，修改原表和新表的名字，最终将数据访问指向新表。在运行正常以后，将原表删除。这里有现成的工具可以协助完成上述操作，“online schema change”,”openark toolkit” 如果只是删除或者更改某一列的默认值，那么直接可以使用 Alert table modify column 和 Alert table alert column 来实现。</li>
</ul>
<h2 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h2><p>说了字段和表再来聊聊索引。对于索引的优化网上有很多的说法，都是在实际工作中总结出来的，这里没有一定的标准。<br>针对我们使用比较多的 InnoDB 的存储引擎(使用的 B-Tree 索引)，推荐几个方法给大家。</p>
<h3 id="索引独立"><a href="#索引独立" class="headerlink" title="索引独立"></a>索引独立</h3><p>“索引独立” 是指索引列不能是表达式的一部分，也不能是函数的参数。例如：假设 User 表中分别把 create_date 和 user_id 设置为索引。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from user where date(create_date) = curdate() </span><br><span class="line">select user_id from user where user_id+1 = 5</span><br></pre></td></tr></table></figure>
</code></pre><p>类似上面的语句就是将索引作为了函数中的参数和表达式的一部分，是不推荐这样使用的。</p>
<h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><p>有时候索引字段长度较大，例如：VarChar，Blob，Text。当搜索的时候，这会让索引变得大且慢。<br>通常的做法是，可以索引开始的部分字符，这样可以节约索引空间，提高索引效率。<br>既然索引全部字符行不通，那么索引多少字符就是我们要讨论的问题了。</p>
<p>这里需要引入一个概念，索引的选择性。索引的选择性是指，不重复的索引值和数据表的记录总数的比值。<br>索引的选择性越高则查询效率越高，因为选择性高的索引可以让 MySQL 在查找时过滤掉更多的行。</p>
<p>例如：有一张 user 表，其中有一个字段是 first_name ，如何计算这个字段的选择性，如下：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select 1.0*count(distinct first_name)/count(*) from user</span><br></pre></td></tr></table></figure>
</code></pre><p>假设这个结果是 0.75 再用 left 函数对该字段取部分字符，例如取从左开始的 3，4，5 个字段。分别查看其选择性，目的是看当选择多少字符的时候，选择性最接近 0.75。</p>
<ul>
<li>从左取3个字段的时候，   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select 1.0*count(distinct left(first_name,3))/count(*) from user</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>结果为0.58 </p>
<ul>
<li>从左取4个字段的时候，   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select 1.0*count(distinct left(first_name,4))/count(*) from user</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>结果为0.67 </p>
<ul>
<li>从左取5个字段的时候，   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select 1.0*count(distinct left(first_name,5))/count(*) from user</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>结果为0.74 </p>
<p>从上面尝试发现，字段 first_name 取左边字符，从 3-5 的获取可以看出，当从左边取第 5 个字符的时候，选择性 0.74 最接近 0.75。<br>因此， 可以<strong>将 FirstName 的前面 5 个字符作为前缀索引</strong> ，这样建立索引的效果基本和 first_name 全部字符建立索引的效果一致。而又不用将 first_name 整个字段都当成索引。<br>于是可以用下面语句修改索引信息：</p>
<p>于是可以用下面语句修改索引信息：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alter table user add key(first_name(5))</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="联合索引及其顺序"><a href="#联合索引及其顺序" class="headerlink" title="联合索引及其顺序"></a>联合索引及其顺序</h3><h4 id="联合索引，顾名思义就是将多个字段联合起来作为索引。"><a href="#联合索引，顾名思义就是将多个字段联合起来作为索引。" class="headerlink" title="联合索引，顾名思义就是将多个字段联合起来作为索引。"></a>联合索引，顾名思义就是将多个字段联合起来作为索引。</h4><p>假设在 user 表中通过搜索 last_name 和 first_name 条件来查找数据。</p>
<p>可能出现以下语句：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Select * from user where last_name = &apos;Green&apos; </span><br><span class="line">Select * from user where last_name = &apos;Green&apos; and  first_name = &apos;Jack&apos; </span><br><span class="line">Select * from user where last_name = &apos;Green&apos; and (first_name = &apos;Jack&apos; or first_name = &apos;Michael&apos;)</span><br><span class="line">Select * from user where last_name = &apos;Green&apos; and  first_name &gt;= &apos;M&apos; and first_name &lt; &apos;N&apos;</span><br></pre></td></tr></table></figure>
</code></pre><p>如果分别在 last_name 和 first_name 上面建立索引：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select * from user where last_name = ‘Green’ and first_name = ‘Jack’</span><br></pre></td></tr></table></figure>
</code></pre><p>当运行上面这段代码的时候，系统会让选择性高的 SQL 的索引生效，另外一个索引是用不上的。因此我们就需要建立多列索引(合并索引)。<br>语句如下：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alter table user add key(last_name , first_name)</span><br></pre></td></tr></table></figure>
</code></pre><h4 id="既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢"><a href="#既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢" class="headerlink" title="既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢?"></a>既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢?</h4><p>在一个多列 B-Tree 索引中，索引列的顺序意味着，索引首先按照最左列进行排序，其次是第二列。<br>索引可以按照升序或者降序进行扫描，以满足精确符合列顺序的 ORDERBY、GROUPBY 和 DISTINCT 等子句的查询需求。</p>
<p>所以，联合索引的顺序是需要考虑的。这里给出的建议是，将选择性最高的索引列放在前面。<br>接上面的例子，还是 last_name 和 first_name 作为多列索引。看谁应该放前面。</p>
<p>通过按照选择性规则，写如下 SQL 语句：</p>
<ul>
<li>先计算last_name的选择性   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select count(disctinc last_name)/count(*) from user</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>结果为0.02 </p>
<ul>
<li>再计算first_name的选择性   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select count(disctinc first_name)/count(*) from user</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>结果0.05 </p>
<ul>
<li>first_name 的选择性要高于 last_name 的选择性。因此调整多列索引的顺序如下：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alter table user add key(first_name , last_name)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>当使用 Select 的数据列只用从索引中取得，而不必从数据表中读取，换句话说查询列要被所使用的索引覆盖。</p>
<p>例如：User 表中将 last_name 作为索引。如果写以下查询语句：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select last_name from user</span><br></pre></td></tr></table></figure>
</code></pre><p>last_name 既作为索引，又在查询内容中显示出来，那么 last_name 就是覆盖索引。<br>覆盖索引是高效查找行方法，通过索引就可以读取数据，就不需要再到数据表中读取数据了。<br>而且 <strong>覆盖索引会以 Using index 作为标示</strong>，可以通过 Explain 语句查看。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT last_name FROM user;</span><br><span class="line">+------+-------------+-------------+------+---------------+-----------+---------+-------+------+--------------------------+</span><br><span class="line">| id   | select_type | table       | type | possible_keys | key       | key_len | ref   | rows | Extra                    |</span><br><span class="line">+------+-------------+-------------+------+---------------+-----------+---------+-------+------+--------------------------+</span><br><span class="line">|    1 | SIMPLE	     | user        | ref  | last_name     | last_name | 4       | const |  100 | Using index              |</span><br><span class="line">+------+-------------+-------------+------+---------------+-----------+---------+-------+------+--------------------------+</span><br><span class="line">100 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="Explain-查看覆盖索引标示"><a href="#Explain-查看覆盖索引标示" class="headerlink" title="Explain 查看覆盖索引标示"></a>Explain 查看覆盖索引标示</h3><p>覆盖索引主要应用在 Count 等一些聚合操作上，提升查询的效率。例如上面提到的 Select count(last_name) from user 就可以把 last_name 设置为索引。<br>还有可以进行列查询的回表优化，如下：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select last_name, first_name from user where last_name=‘Jack’</span><br></pre></td></tr></table></figure>
</code></pre><p>如果此时 last_name 设置为索引，可以将 last_name 和 first_name 设置为多列索引(联合索引)。<br>避免回表行为的发生。这里的回表是指二级索引搜索到以后，再找到聚合索引，然后在查找 PK 的过程。<br>这里需要通过两次搜索完成。简单点说就是使用了覆盖索引以后，一次就可以查到想要的记录，不用在查第二次了。</p>
<p><img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/回表示意图.jpg" alt><br>回表示意图</p>
<h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><p>作为程序开发人员来说，使用得最多的就是 SQL 语句了，最多的操作就是查询了。我们一起来看看，哪些因素会影响查询记录，查询基本原理是什么，以及如何发现和优化 SQL 语句。</p>
<h3 id="影响查询效率的因素"><a href="#影响查询效率的因素" class="headerlink" title="影响查询效率的因素"></a>影响查询效率的因素</h3><p>一般来说，影响查询的因素有三部分组成，如下：</p>
<ul>
<li>响应时间，由两部分组成，他们分别是，服务时间和排队时间。服务时间是指数据库处理查询花费的时间。<br>排队时间是指服务器因为等待某些资源花费的时间。例如：I/O 操作，等待其他事务释放锁的时间。</li>
<li>扫描记录行数，在查询过程中数据库锁扫描的行记录。理想情况下扫描的行数和返回的行数是相同的。不过通常来说，扫描的行数都会大于返回记录的行数。</li>
<li>返回记录行数，返回实际要查询的结果。</li>
</ul>
<h3 id="查询基础"><a href="#查询基础" class="headerlink" title="查询基础"></a>查询基础</h3><p><img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/查询流程图.jpg" alt><br>查询流程图</p>
<p>说了影响查询效率的因素以后，来看看查询这件事情在 MySQL 中是如何运作的，可以帮助我理解，查询优化工作是在哪里进行的：</p>
<ul>
<li>客户端发送一条查询给服务器。</li>
<li>服务器先检查查询缓存，如果命中了缓存，则立刻返回存储在缓存中的结果。</li>
<li>解析器对 SQL 进行解析，它通过关键字将 SQL 语句进行解析，并生成一棵对应的“解析树”。MySQL 解析器将使用 MySQL 语法规则验证和解析查询。</li>
<li>预处理器则根据一些 MySQL 规则进一步检查解析树是否合法，并且验证权限。例如，检查数据表和数据列是否存在，解析名字和别名看是否有歧义。</li>
<li>MySQL 根据优化器生成的执行计划，调用存储引擎的 API 来执行查询。</li>
<li>将结果返回给客户端。</li>
</ul>
<h3 id="如何发现查询慢的-SQL"><a href="#如何发现查询慢的-SQL" class="headerlink" title="如何发现查询慢的 SQL"></a>如何发现查询慢的 SQL</h3><p>说了影响查询缓慢的因素以及查询的基本流程以后，再来看看如何发现查询慢的 SQL。这里 MySQL 提供了日志，其中可以查询执行比较慢的 SQL。</p>
<p>①查看慢查询日志是否开启</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &apos;%slow_query_log%&apos;;</span><br></pre></td></tr></table></figure>
</code></pre><p> <img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/查看慢查询日志是否开启.jpg" alt></p>
<p>②如果没有开启，通过命令开启慢查询日志</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL slow_query_log=1;</span><br></pre></td></tr></table></figure>
</code></pre><p> <img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/开启慢查询日志.jpg" alt></p>
<p>③设置慢查询日志的时间，这里的单位是秒，意思是只要是执行时间超过 X 秒的查询语句被记录到这个日志中。这里的 X 就是你要设置的。(下面的例子设置的是 3 秒)</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL long_query_time=3;</span><br></pre></td></tr></table></figure>
</code></pre><p> <img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/设置慢查询日志的时间.jpg" alt></p>
<p>④查看多少 SQL 语句是超过查询阀值的(3 秒)<br> <img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/查看sql语句.jpg" alt></p>
<h3 id="Explain-分析-SQL-查询"><a href="#Explain-分析-SQL-查询" class="headerlink" title="Explain 分析 SQL 查询"></a>Explain 分析 SQL 查询</h3><p>通过上面的方法可以知道哪些 SQL 花费了较多的时间，那么如何对这些 SQL 语句进行分析呢。毕竟，我们的目的是通过分析以后，优化 SQL 从而提高其性能。<br>将 Explain 关键字放在要执行的 SQL 语句前面，可以模拟优化器执行 SQL 语句，从而知道 MySQL 是如何处理你的 SQL 语句的。</p>
<p><img src="/2020/04/28/MySQL性能优化之骨灰级高阶神技/Explain.jpg" alt><br>Explain 执行 SQL 示意图<br>上面每个字段的含义，在这里不展开描述。</p>
<h3 id="SQL-优化建议"><a href="#SQL-优化建议" class="headerlink" title="SQL 优化建议"></a>SQL 优化建议</h3><p>如果发现慢查询的 SQL，我们就需要针对其问题进行优化。这里针对几个常见的 SQL 给出一些优化建议。<br>类似 SQL 优化的文章和例子在网上种类繁多，千奇百怪。建议在优化之前，先查看慢查询日志和 Explain 的语句，再进行优化，做到有的放矢。</p>
<h4 id="①Count-优化"><a href="#①Count-优化" class="headerlink" title="①Count 优化"></a>①Count 优化</h4><p>从 user 表中搜索 id 大于 7 的所有用户。如果是 InnoDB 存储引擎会进行逐行扫描，如果表中记录比较多，性能就是问题了。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select count(*) from user where id&gt;7</span><br></pre></td></tr></table></figure>
</code></pre><p>如果先将所有的行数 Count 出来，再减去 id&lt;=7 的记录，这样速度就会快一些。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select (select count(*) - (select count(*) from user where id &lt;=7) from user)</span><br></pre></td></tr></table></figure>
</code></pre><p>如果有一个货物表 items，其中有一个 color 字段来表示货物的颜色，如果需要知道颜色是蓝色或者红色的货物的数量，可以这么写：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Select count(color=&apos;blue&apos; or color=&apos;red&apos;) from items </span><br><span class="line">Select count(*) from items where color=&apos;blue&apos; and color=&apos;red&apos;</span><br></pre></td></tr></table></figure>
</code></pre><p>不过颜色本身是除斥的字段，所以可以优化成下面的 SQL。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select count(color=&apos;blue&apos; or null) as blue, count(color=&apos;red&apos; or null) as red from items</span><br></pre></td></tr></table></figure>
</code></pre><h4 id="②GROUPBY-优化"><a href="#②GROUPBY-优化" class="headerlink" title="②GROUPBY 优化"></a>②GROUPBY 优化</h4><p>MySQL 通过索引来优化 GROUPBY 查询。在无法使用索引的时候，会使用两种策略优化：临时表和文件排序分组。可以通过两个参数 <strong>SQL_BIG_RESULT</strong> 和 <strong>SQL_SMALL_RESULT</strong> 提升其性能。这两个参数只对 Select 语句有效。它们告诉优化器对 GROUPBY 查询使用临时表及排序。</p>
<ul>
<li>SQL_SMALL_RESULT 告诉优化器结果集会很小，可以将结果集放在内存中的索引临时表，以避免排序操作。</li>
<li>SQL_BIG_RESULT，则告诉优化器结果集可能会非常大，建议使用磁盘临时表做排序操作。</li>
</ul>
<p>例如：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select SQL_BUFFER_RESULT field1, count(*) from table1 groupby field1</span><br></pre></td></tr></table></figure>
</code></pre><p>假设两个表做关联查询，选择查询表中的标识列(主键)分组效率会高。<br>例如 actor 表和 film 表通过 actorId 做关联，查询如下：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select actor.FirstName, actor.LastName,count(*) from film inner join actor using(actorId) Group by actor.FirstName,actor.LastName</span><br></pre></td></tr></table></figure>
</code></pre><p>就可以修改为：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select actor.FirstName, actor.LastName, count(*) from film inner join actor using(actorId) Group by film.actorId</span><br></pre></td></tr></table></figure>
</code></pre><p>③Limit<br>Limit 对我们再熟悉也不过了，特别是在做分页操作的时候，经常会用到它。但在偏移量非常的时候问题就来了。<br>例如，Limit 1000，20 就需要偏移 1000 条数据以后，再返回后面的 20 条记录，前面的 1000 条数据是被抛弃掉的。<br>按照上例 SQL 代码如下：</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select name from user order by id limit 1000,20</span><br></pre></td></tr></table></figure>
</code></pre><p>这里通过 id 索引到第 1001 条记录，然后取 20 条记录。这里利用 id 的索引的优势直接跳过了前面 1000 条记录。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select name from user where id &gt;= 1001 order by id limit 20</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从开发者的角度了解 MySQL 的应用优化。从数据类型的选择开始，针对数值类型，字符类型，时间类型进行了举例说明。<br>接下来谈到，作为数据表的查询，修改的优化，我们应该注意哪些细节。然后，聊了索引独立，前缀索引，多列索引，覆盖索引的优化方法。<br>最后，针对使用最多的查询优化进行了探讨。从影响查询的因素到查询基础，再到如何发现慢查询，用几个 SQL 优化的建议结束了我们的 MySQL 应用优化之旅。<br>写完全文感觉 MySQL 博大精深，需要学习的东西很多，一文不能面面俱到，还需不断学习。</p>
</the></excerpt>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2020/04/28/MySQL性能优化之骨灰级高阶神技/">MySQL性能优化之骨灰级高阶神技</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Phantoms007</a></p>
        <p><span>发布时间:</span>2020-04-28, 18:00:00</p>
        <p><span>最后更新:</span>2020-04-29, 16:44:19</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2020/04/28/MySQL性能优化之骨灰级高阶神技/" title="MySQL性能优化之骨灰级高阶神技">https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/</a>
            <span class="copy-path" data-clipboard-text="原文: https://phantoms007.github.io/2020/04/28/MySQL性能优化之骨灰级高阶神技/　　作者: Phantoms007" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2020/04/29/Post-与-Get-的区别/">
                    Post 与 Get 的区别
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2020/04/26/innodb-添加Sphinx中文快速搜索支持/">
                    innodb 添加Sphinx中文快速搜索支持
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL性能优化之骨灰级高阶神技"><span class="toc-number">1.</span> <span class="toc-text">MySQL性能优化之骨灰级高阶神技</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据类型优化"><span class="toc-number">2.</span> <span class="toc-text">数据类型优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数值类型"><span class="toc-number">2.1.</span> <span class="toc-text">数值类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符类型"><span class="toc-number">2.2.</span> <span class="toc-text">字符类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#时间类型"><span class="toc-number">2.3.</span> <span class="toc-text">时间类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#区别一：存储数据方式不一样。"><span class="toc-number">2.3.1.</span> <span class="toc-text">区别一：存储数据方式不一样。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#区别二：两者存储时间的范围不一样。"><span class="toc-number">2.3.2.</span> <span class="toc-text">区别二：两者存储时间的范围不一样。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据表查询-修改优化"><span class="toc-number">3.</span> <span class="toc-text">数据表查询/修改优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#两种小技巧"><span class="toc-number">3.1.</span> <span class="toc-text">两种小技巧</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引优化"><span class="toc-number">4.</span> <span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#索引独立"><span class="toc-number">4.1.</span> <span class="toc-text">索引独立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前缀索引"><span class="toc-number">4.2.</span> <span class="toc-text">前缀索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#联合索引及其顺序"><span class="toc-number">4.3.</span> <span class="toc-text">联合索引及其顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#联合索引，顾名思义就是将多个字段联合起来作为索引。"><span class="toc-number">4.3.1.</span> <span class="toc-text">联合索引，顾名思义就是将多个字段联合起来作为索引。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢"><span class="toc-number">4.3.2.</span> <span class="toc-text">既然定义了联合索引，那么其中的索引顺序是否也需要考虑呢?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#覆盖索引"><span class="toc-number">4.4.</span> <span class="toc-text">覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Explain-查看覆盖索引标示"><span class="toc-number">4.5.</span> <span class="toc-text">Explain 查看覆盖索引标示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询优化"><span class="toc-number">5.</span> <span class="toc-text">查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#影响查询效率的因素"><span class="toc-number">5.1.</span> <span class="toc-text">影响查询效率的因素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询基础"><span class="toc-number">5.2.</span> <span class="toc-text">查询基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何发现查询慢的-SQL"><span class="toc-number">5.3.</span> <span class="toc-text">如何发现查询慢的 SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Explain-分析-SQL-查询"><span class="toc-number">5.4.</span> <span class="toc-text">Explain 分析 SQL 查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-优化建议"><span class="toc-number">5.5.</span> <span class="toc-text">SQL 优化建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#①Count-优化"><span class="toc-number">5.5.1.</span> <span class="toc-text">①Count 优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#②GROUPBY-优化"><span class="toc-number">5.5.2.</span> <span class="toc-text">②GROUPBY 优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>





    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2020/04/29/Post-与-Get-的区别/" title="上一篇: Post 与 Get 的区别">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2020/04/26/innodb-添加Sphinx中文快速搜索支持/" title="下一篇: innodb 添加Sphinx中文快速搜索支持">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/29/Post-与-Get-的区别/">Post 与 Get 的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/28/MySQL性能优化之骨灰级高阶神技/">MySQL性能优化之骨灰级高阶神技</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/26/innodb-添加Sphinx中文快速搜索支持/">innodb 添加Sphinx中文快速搜索支持</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/php简单秒杀场景/">php redis简单秒杀场景</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/21/雪花算法及运用PHP/">雪花算法及运用PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/19/并发扣款一致性优化，CAS下ABA问题，这个话题还没聊完！！！/">并发扣款一致性优化，CAS下ABA问题，这个话题还没聊完！！！</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/19/并发扣款，如何保证数据的一致性？/">并发扣款，如何保证数据的一致性？</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/动态规划算法-漫画版/">动态规划算法(漫画版)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/19/如何避免回表查询及什么是索引覆盖/">如何避免回表查询及什么是索引覆盖</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/17/Centos6.9 LAMP源码编译参考手册/">Centos7.3 LAMP源码编译参考手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/09/MySQL监控/">MySQL监控--初级入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/05/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/29/Windows下生成PDF/">生成复杂PDF-Windows篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/LNMP搭建-Linux搭建/">服务器集群-环境搭建（二）Nginx服务器搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/27/虚拟机安装centos/">服务器集群-环境搭建（一）虚拟机安装精简centos7.2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/Linxu常用工具安装/">Linxu常用工具安装</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2019-2020 Phantoms007
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="/js/require.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 6;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>



  </div>
</body>
</html>